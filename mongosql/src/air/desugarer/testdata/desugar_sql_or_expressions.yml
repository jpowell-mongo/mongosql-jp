tests:
  - name: "nothing to desugar"
    input:
      - { $match: { $expr: { $or: [ “$a”, “$b” ] } } }
    expected:
      - { $match: { $expr: { $or: [ “$a”, “$b” ] } } }
  - name: "Top Level OR"
    input:
      - { $match: { $expr: { $sqlOr: [ “$a”, “$b” ] } } }
    expected:
      - { $match: { $expr: { $or: [ “$a”, “$b” ] } } }
  - name: "OR with subquery containing filter stage with $sqlAnd (not flipped)"
    input:
      - { $match: { $expr: { $sqlOr: [ '$a', { $subqueryExists: { collection: 'bar', pipeline: [ { $match: { $expr: { $sqlAnd: [ '$b', '$c' ] } } } ] } } ] } } }
    expected:
      - { $match: { $expr: { $or: [ '$a', { $subqueryExists: { collection: 'bar', pipeline: [ { $match: { $expr: { $sqlAnd: [ '$b', '$c' ] } } } ] } } ] } } }
  - name: "OR with subquery containing filter stage with $sqlOr (both flipped)"
    input:
      - { $match: { $expr: { $sqlOr: [ '$a', { $subqueryExists: { collection: 'bar', pipeline: [ { $match: { $expr: { $sqlOr: [ '$b', '$c' ] } } } ] } } ] } } }
    expected:
      - { $match: { $expr: { $or: [ '$a', { $subqueryExists: { collection: 'bar', pipeline: [ { $match: { $expr: { $or: [ '$b', '$c' ] } } } ] } } ] } } }
  - name: "OR with $subquery in project stage with $sqlOr (not flipped in subquery)"
    input:
      - { $match: { $expr: { $sqlOr: [ '$a', { $subquery: { collection: 'bar', outputPath: [ 'x' ], pipeline: [ { $project: { x: { $sqlOr: [ '$b', '$c' ] } } } ] } } ] } } }
    expected:
      - { $match: { $expr: { $or: [ '$a', { $subquery: { collection: 'bar', outputPath: [ 'x' ], pipeline: [ { $project: { x: { $sqlOr: [ '$b', '$c' ] } } } ] } } ] } } }

  - name: "No desugar outside filter stages"
    input:
      - { $project: { _id: 0, expr: { $sqlOr: [ '$a', '$b' ] } } }
    expected:
      - { $project: { _id: 0, expr: { $sqlOr: [ '$a', '$b' ] } } }

  - name: "a AND (b OR C)"
    input:
      - { $match: { $expr: { $sqlAnd: [ '$a', { $sqlOr: [ '$b', '$c' ] } ] } } }
    expected:
      - { $match: { $expr: { $sqlAnd: [ '$a', { $or: [ '$b', '$c' ] } ] } } }
  - name: "OR with complex predicates"
    input:
    - { $match: { $expr: { $sqlOr: [ { $sqlGt: ['$a', 100] }, { $sqlGt: ['$b', 3000] } ] } } }
    expected:
      - { $match: { $expr: { $or: [ { $gt: ['$a', 100] }, { $gt: ['$b', 3000] } ] } } }
  - name: "OR nested expression - (a OR (b OR c))"
    input:
      - { $match: { $expr: { $sqlOr: [ '$a', { $sqlOr: [ '$b', '$c' ] } ] } } }
    expected:
      - { $match: { $expr: { $or: [ '$a', { $or: [ '$b', '$c' ] } ] } } }
  - name: "nested ORs with complex children"
    input:
    - { $match:
               { $expr:
                   { $sqlOr:
                       [
                         { $sqlOr: [ { $sqlLt: [ "$a", 1 ] }, { $sqlEq: [ "$b", 2 ] } ] } ,
                         { $sqlGt: [ "$c", 3 ] }
                       ]
                   }
               }
    }
    expected:
      -  { $match: { $expr: { $or: [ { $or: [ { $lt: [ "$a", 1 ] }, { $eq: [ "$b", 2 ] } ] }, { $gt: [ "$c", 3 ] } ] } } }
  - name: "((a < 1) OR (b = 2)) OR (c > 3))"
    input:
      - { $match: { $expr: { $sqlOr: [ { $sqlOr: [ { $sqlLt: [ "$a", 1 ] }, { $sqlEq: [ "$b", 2 ] } ] }, { $sqlGt: [ "$c", 3 ] } ] } } }
    expected:
      -  { $match: { $expr: { $or: [ { $or: [ { $lt: [ "$a", 1 ] }, { $eq: [ "$b", 2 ] } ] }, { $gt: [ "$c", 3 ] } ] } } }
  - name: "OR in match stage within subquery in non-match stage is rewritten"
    input:
      - { $project: { x: { $subquery: { collection: "foo", outputPath: ["p"], pipeline: [{ $match: { $expr: { $sqlOr: ["$a", "$b"] } } }] } } } }
    expected:
      - { $project: { x: { $subquery: { collection: "foo", outputPath: ["p"], pipeline: [{ $match: { $expr: { $or: ["$a", "$b"] } } }] } } } }
  - name: "Deeply nested SQL descendants are all rewritten"
    input:
      - { $match: { $expr: { $sqlOr: [{ $sqlAnd: [{ $sqlLte: ["$a", 1] }, { $sqlEq: ["$b", 2] }] }, { $sqlAnd: [{ $sqlNe: ["$c", 3] }, { $sqlGte: ["$d", 4] }] }] } } }
    expected:
      - { $match: { $expr: { $or: [{ $and: [{ $lte: ["$a", 1] }, { $eq: ["$b", 2] }] }, { $and: [{ $ne: ["$c", 3] }, { $gte: ["$d", 4] }] }] } } }
  - name: "Complex SQL-semantic child of SQL-semantic OR is rewritten when its sibling is a $subquery expression that uses $sqlAnd inside its expression"
    input:
      - { $match: { $expr: { $sqlOr: [ { $subquery: { collection: "foo", outputPath: ["p"], pipeline: [ { $project: { p: { $sqlAnd: [ { $sqlEq: ["$x", 10] }, { $sqlLt: ["$y", 20] } ] } } } ] } }, { $sqlEq: ["$a", 1] } ] } } }
    expected:
      - { $match: { $expr: { $or: [ { $subquery: { collection: "foo", outputPath: ["p"], pipeline: [ { $project: { p: { $sqlAnd: [ { $sqlEq: ["$x", 10] }, { $sqlLt: ["$y", 20] } ] } } } ] } }, { $eq: ["$a", 1] } ] } } }
